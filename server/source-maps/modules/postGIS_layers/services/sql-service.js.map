{"version":3,"sources":["modules/postGIS_layers/services/sql-service.ts"],"names":[],"mappings":"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","file":"../../../../modules/postGIS_layers/services/sql-service.js","sourcesContent":["import Sequelize = require('sequelize');\r\nimport dbConnection = require('../../../core/db-connection');\r\n\r\nvar db = dbConnection();\r\n\r\nclass SQLService {\r\n    \r\n    // getList(searchValue: string): Promise<any[]> {\r\n\r\n    //     var findOptions: Sequelize.FindOptions = {\r\n    //         order: [\r\n    //             'lastName'\r\n    //         ]\r\n    //     };\r\n\r\n    //     if (searchValue) {\r\n    //         findOptions.where = {\r\n    //             $or: [\r\n    //                 { firstName: { $iLike: `%${searchValue}%` } },\r\n    //                 { lastName: { $iLike: `%${searchValue}%` } },\r\n    //                 { email: { $iLike: `%${searchValue}%` } },\r\n    //             ]\r\n    //         }\r\n    //     }\r\n        \r\n    //     return UserModel.Model.findAll(findOptions);\r\n    // }\r\n\r\n    get(table: string): Promise<any> {\r\n        return db.query(\"SELECT *,ST_Length(ST_Transform(geom,2965)), ST_Area(ST_Transform(geom,2965)) from mycube.t\" + table + ' ORDER BY id')\r\n        //return db.query('SELECT * FROM $1', { bind: [table], type: sequelize.queryTypes.SELECT})\r\n    }\r\n\r\n    getsheets(table: string): Promise<any> {\r\n        let promise = new Promise((resolve, reject) => {\r\n            let responsehtml: string = \"<html><body><table>\"\r\n            this.getschema(table).then((schemaarray) => {\r\n                let schema = schemaarray[0]\r\n                //header information\r\n                responsehtml += \"<tr>\"\r\n                schema.forEach(schemaelement => {\r\n                    if (schemaelement['field'] != 'geom') {\r\n                    responsehtml += \"<th>\" + [schemaelement['field']] + \"</th>\"}\r\n                });\r\n                responsehtml += \"<th>Length (ft)</th>\"\r\n                responsehtml += \"<th>Area (sqft)</th>\"\r\n                responsehtml += \"</tr>\"\r\n\r\n                this.get(table).then((dataarray) => {\r\n                    let data = (dataarray[0])\r\n                    console.log(data)\r\n                    data.forEach(dataelement => {\r\n                        responsehtml += \"<tr>\"\r\n                        schema.forEach(schemaelement => {\r\n                            if (schemaelement['field'] != 'geom') {\r\n                                if (!dataelement[schemaelement['field']]||dataelement[schemaelement['field']]==\"null\") {dataelement[schemaelement['field']] = \"\"}\r\n                            responsehtml += \"<td>\" + dataelement[schemaelement['field']] + \"</td>\"}\r\n                        });\r\n                        responsehtml += \"<td>\" + dataelement['st_length'] + '</td>'\r\n                        responsehtml += \"<td>\" + dataelement['st_area'] + '</td>'\r\n                        responsehtml += \"</tr>\"\r\n                    });\r\n                    responsehtml += \"</table></body></html>\"\r\n                    resolve(responsehtml)\r\n                })\r\n            })\r\n        })\r\n        return promise\r\n    }\r\n    \r\n    getlength(table: string, id: number): Promise<any> {\r\n        return db.query('SELECT ST_Length(ST_Transform(geom,2965)) from mycube.t' + table + ' WHERE id=' + id + ';')\r\n    }\r\n\r\n    create(table: string): Promise<any> {\r\n    //     db.query(`CREATE SEQUENCE public.\"test3_ID_seq\"\r\n    //     INCREMENT 1\r\n    //     MINVALUE 1\r\n    //     MAXVALUE 9223372036854775807\r\n    //     START 38\r\n    //     CACHE 1;\r\n    //   ALTER TABLE public.\"test3_ID_seq\"\r\n    //     OWNER TO geoadmin;\r\n    //   `)\r\n        return db.query(`CREATE TABLE mycube.t` + table + ` (\r\n            ID    SERIAL PRIMARY KEY,\r\n            geom   geometry\r\n        );\r\n        `)\r\n    }\r\n\r\n    createCommentTable(table: string): Promise<any> {\r\n        return db.query(`CREATE TABLE mycube.c` + table + ` (\r\n            ID   SERIAL PRIMARY KEY,\r\n            userID integer,\r\n            comment text,\r\n            geom geometry,\r\n            featureID integer,\r\n            createdAt timestamp with time zone default now());\r\n            `)\r\n    }\r\n\r\n    setSRID(table): Promise<any> {\r\n        return db.query(`SELECT UpdateGeometrySRID('mycube', 't` + table + `','geom',4326);`)\r\n    }\r\n\r\n    addColumn(table: string, field: string, type: string, label: boolean): Promise<any> {\r\n        db.query('ALTER TABLE mycube.t' + table + ' ADD \"' + field + '\" ' + type)\r\n        if (label == true) {db.query(`COMMENT ON COLUMN mycube.t` + table + '.\"' + field + `\" IS '` + field + `';`)}        \r\n        return  db.query(\"SELECT col_description(41644,3);\")\r\n        \r\n    }\r\n\r\n    deleteTable(table: string): Promise<any> {\r\n        return db.query('DROP TABLE mycube.t' + table)\r\n    }\r\n\r\n    deleteCommentTable(table: string): Promise<any> {\r\n        return db.query('DROP TABLE mycube.c' + table)\r\n    }\r\n\r\n    addRecord(table: string, geometry: string): Promise<any> {\r\n        return db.query(\"INSERT INTO mycube.t\" + table + \" (geom) VALUES (ST_SetSRID(ST_GeomFromGeoJSON('\" + geometry + \"'),4326)) RETURNING id;\")\r\n    }\r\n\r\n    deleteRecord(table: string, id: string): Promise<any> {\r\n        return db.query(\"DELETE FROM mycube.t\" + table + \" WHERE id = '\" + id + \"';\")\r\n    }\r\n    \r\n    getschema(table:string): Promise<any> {\r\n        return db.query(\"SELECT column_name AS field, data_type as type FROM information_schema.columns WHERE table_schema = 'mycube' AND table_name = 't\" + table + \"'\")\r\n    }\r\n    getsingle(table:string, id:string): Promise<any> {\r\n        return db.query(\"SELECT * FROM mycube.t\" + table + \" WHERE id='\" + id + \"';\")\r\n    }\r\n    getcomments(table:string, id:string): Promise<any> {\r\n        return db.query(\"SELECT mycube.c\" + table + '.*, users.\"firstName\", users.\"lastName\" FROM mycube.c' + table + \"  INNER JOIN users ON mycube.c\" + table + '.userid = users.\"ID\" WHERE mycube.c' + table + \".featureid='\" + id + \"';\")\r\n    }\r\n    addComment(table:string, featureID:string, comment:string, userid: number): Promise<any> {\r\n        return db.query(\"INSERT INTO mycube.c\" + table + '(userid, comment, featureid) VALUES (' + userid + \",'\" + comment + \"',\" + featureID + \")\")\r\n    }\r\n    deleteComment(table:string, id:string): Promise<any> {\r\n        return db.query(\"DELETE FROM mycube.c\" + table + ' WHERE id=' + id + \";\")\r\n    }\r\n    update(table: string, id: string, field: string, type: string, value: any) {\r\n        switch (type) {\r\n            case \"integer\": {\r\n                return db.query(\"UPDATE mycube.t\" + table + ' SET \"' + field + '\" = ' + value + \" WHERE id='\" + id + \"';\")\r\n            }\r\n            case \"double precision\": {\r\n                return db.query(\"UPDATE mycube.t\" + table + ' SET \"' + field + '\" = ' + value + \" WHERE id='\" + id + \"';\")\r\n            }\r\n            case \"text\": {\r\n                return db.query(\"UPDATE mycube.t\" + table + ' SET \"' + field + '\" = ' + \"'\" + value + \"' WHERE \" + \"id='\" + id + \"';\") \r\n            }\r\n            case \"boolean\": {\r\n                return db.query(\"UPDATE mycube.t\" + table + ' SET \"' + field + '\" = ' + value + \" WHERE id='\" + id + \"';\")\r\n            }\r\n            case \"date\": {\r\n                return db.query(\"UPDATE mycube.t\" + table + ' SET \"' + field + '\" = ' + \"'\" + value + \"' WHERE id='\" + id + \"';\")\r\n            }\r\n        }\r\n    }\r\n    getOID(table: string) {\r\n        return db.query(\"SELECT attrelid FROM pg_attribute WHERE attrelid = 'mycube.t\" + table + \"'::regclass;\")\r\n    }\r\n\r\n    getColumnCount(table: string) {\r\n        return db.query(\"select count(column_name) from information_schema.columns where table_name='t\" + table + \"';\")\r\n        //return db.query(\"select count(*) from information_schema.columns where table_name='mycube.t\" + table + \"';\")\r\n    }\r\n\r\n    getIsLabel(oid: number, field:number) {\r\n        return db.query(\"SELECT col_description(\" + oid + \",\" + field + \");\")\r\n    }\r\n}\r\n\r\nexport = SQLService;"]}